
- [defer çš„å®šä¹‰](#deferçš„å®šä¹‰)
- [ä¸ºä»€ä¹ˆè¦æœ‰ defer](#ä¸ºä»€ä¹ˆè¦æœ‰defer)
- [defer çš„ç‰¹æ€§](#deferçš„ç‰¹æ€§)
- [å¦‚ä½•è®°ä½ defer çš„ç‰¹æ€§](#å¦‚ä½•è®°ä½deferçš„ç‰¹æ€§)


# defer çš„å®šä¹‰
> A defer statement defers the execution of a function until the surrounding function returns.

ä¸€å¥è¯æ€»ç»“ï¼š`defer`å°±æ˜¯ç”¨æ¥å»¶è¿Ÿæ‰§è¡Œå‡½æ•°çš„æŠ€æœ¯æ‰‹æ®µã€‚

è™½ç„¶åªæœ‰çŸ­çŸ­ä¸€å¥è¯ï¼Œä½†æ˜¯æˆ‘ä»¬ä¹Ÿå¯ä»¥ä»ä¸­è·å–å¾ˆå¤šä¿¡æ¯ï¼š

1ã€`defer`åé¢è·Ÿå‡½æ•°:`defers the execution of a `**`function`**ï¼ˆå’Œæ–¹æ³•`method`ï¼Œåæ–‡ä¼šè®²åˆ°æ–¹æ³•`method`æœ¬è´¨ä¸Šå°±æ˜¯å‡½æ•°`function`ï¼‰ã€‚

2ã€`defer`çš„ä½œç”¨å°±æ˜¯åœ¨ç‰¹å®šæ—¶æœºæ¿€æ´»åæ¥çš„å‡½æ•°:`the execution`ã€‚

3ã€æ‰€è°“çš„ç‰¹å®šæ—¶æœº:`until the surrounding function returns`ã€‚

æˆ‘ä»¬ä¼šå‘ç°ï¼Œä¸‹é¢è¿™å¥è¯å°±æ˜¯å¯¹ä¸Šè¿°ä¸‰æ¡æ€»ç»“çš„å†æ¬¡è¯´æ˜ã€‚

> A "defer" statement invokes a function whose execution is deferred to the moment the surrounding function returns, either because the surrounding function executed a return statement, reached the end of its function body, or because the corresponding goroutine is panicking.

# ä¸ºä»€ä¹ˆè¦æœ‰ defer
å†æ¬¡é‡ç”³ï¼Œ**`defer`çš„æœ¬è´¨å°±æ˜¯å»¶è¿Ÿè‡ªåŠ¨æ‰§è¡Œå‡½æ•°**ã€‚

å®ƒçš„å‡ºç°å°±æ˜¯ä¸ºäº†æ›´åŠ ä¾¿åˆ©çš„è¿›è¡Œèµ„æºç®¡ç†ï¼Œå‡è½»ç¨‹åºå‘˜çš„å¿ƒæ™ºè´Ÿæ‹…ï¼Œæé«˜ä»£ç çš„å¯è¯»æ€§ã€å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§ã€‚

å‡å¦‚`Go`æ²¡æœ‰`defer`æœºåˆ¶ï¼Œä¸ºäº†å®ç°ä¸€ä¸ªé”ä¿æŠ¤çš„æ–‡ä»¶æ“ä½œã€‚æˆ‘ä»¬å¾—è¿™ä¹ˆå†™ï¼š

```Go
func writeToFile(fname string, data []byte, mu *sync.Mutex) error {
    mu.Lock()
    f, err := os.OpenFile(fname, os.O_RDWR, 0666)
    if err != nil {
    mu.Unlock()
    return err
    }

    _, err = f.Seek(0, 2)
    if err != nil {
        f.Close()
        mu.Unlock()
        return err
    }

    _, err = f.Write(data)
    if err != nil {
        f.Close()
        mu.Unlock()
        return err
    }

    err = f.Sync()
    if err != nil {
        f.Close()
        mu.Unlock()
        return err
    }

    err = f.Close()
    if err != nil {
        mu.Unlock()
        return err
    }

    mu.Unlock()
    return nil
}
```

å°±åƒè€å¥¶å¥¶çš„è£¹è„šå¸ƒâ€”â€”åˆè‡­åˆé•¿ã€‚

æˆ‘ä»¬æ¯æ¬¡æ“ä½œï¼Œéƒ½å¾—å¤„ç†èµ„æºçš„é‡Šæ”¾ï¼šé”çš„é‡Šæ”¾ã€æ–‡ä»¶å¥æŸ„çš„å…³é—­ã€‚

ä»…ä»…ä¸¤ä¸ªèµ„æºçš„é‡Šæ”¾æ“ä½œï¼Œæˆ‘ä»¬åœ¨ç¼–å†™ä»£ç å°±éœ€è¦ã€å¦‚ä¸´æ·±æ¸Šï¼Œå¦‚å±¥è–„å†°ã€ã€‚å¢åŠ èµ„æºçš„å‚ä¸æ•°ï¼Œé‚£ç®€ç›´ä¸å ªè®¾æƒ³ã€‚

å¹¸å¥½ï¼Œ`Go`æœ‰`defer`æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥æ”¹å†™å¦‚ä¸‹ï¼š

```go
func writeToFile(fname string, data []byte, mu *sync.Mutex) error {

    mu.Lock()
    defer mu.Unlock()

    f, err := os.OpenFile(fname, os.O_RDWR, 0666)
    if err != nil {
        return err
    }
    defer f.Close()
    
    _, err = f.Seek(0, 2)
    if err != nil {
        return err
    }

    _, err = f.Write(data)
    if err != nil {
        return err
    }

    return f.Sync()
}
```

æˆ‘ä»¬æ‰€éœ€è¦åšçš„å°±æ˜¯ç”³è¯·èµ„æºä¹‹åï¼Œé©¬ä¸Š`defer+`é‡Šæ”¾èµ„æºçš„é€»è¾‘ã€‚å½“`writeToFile`è¿è¡Œç»“æŸæ—¶ï¼Œä¼šè‡ªåŠ¨é‡Šæ”¾é”å’Œå…³é—­æ–‡ä»¶å¥æŸ„ã€‚

# defer çš„ç‰¹æ€§

ä¸Šé¢å¯¹`defer`çš„æè¿°ï¼Œåªæ˜¯éå¸¸ç²—ç³™çš„è®²è§£ã€‚ä¸‹é¢è®©æˆ‘ä»¬æ²‰æµ¸åˆ°`defer`çš„å…·ä½“æŠ€æœ¯ç»†èŠ‚ã€‚

ä¸ºäº†è®¨è®ºä¸€ä¸ªæŠ€æœ¯ï¼Œæå‡ºå¥½çš„é—®é¢˜æ˜¯ç†è§£å…¶è¦é¢†çš„å› ç´ ä¹‹ä¸€ã€‚æ¯”å¦‚ï¼š

* `defer`åæ¥å‡½æ•°ï¼Œé‚£ä¹ˆå‡½æ•°çš„å‚æ•°ä»€ä¹ˆæ—¶å€™ç¡®å®šï¼Ÿï¼ˆè¦çŸ¥é“åŒæ ·çš„å˜é‡ï¼Œåœ¨å‡½æ•°é€€å‡ºæ—¶ä¸åˆšè¿›å…¥å‡½æ•°æ—¶ï¼Œå†…å®¹å¯èƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼‰
* å¯ä»¥åæ¥æ–¹æ³•å—ï¼Ÿ

* `defer`åçš„å‡½æ•°çœŸæ­£æ‰§è¡Œæ—¶æœºæ˜¯ï¼šå£°æ˜`defer`è¡¨è¾¾å¼çš„å‡½æ•°æ‰§è¡Œç»“æŸæ—¶ã€‚é‚£ä¹ˆè¿™ä¸ªæ‰€è°“çš„å‡½æ•°æ‰§è¡Œç»“æŸæ—¶ï¼Œæ˜¯è¿”å›åï¼Œè¿˜æ˜¯è¿”å›å‰ï¼Ÿè¿˜æ˜¯å…¶ä»–ä»€ä¹ˆæ—¶é—´ç‚¹ï¼Ÿ
* å¦‚æœä¸€ä¸ªå‡½æ•°ä¹‹ä¸­ï¼Œå£°æ˜äº†å¤šä¸ª`defer`è¡¨è¾¾å¼ï¼Œè™½ç„¶éƒ½æ˜¯å‡½æ•°é€€å‡ºæ—¶è°ƒç”¨ï¼Œä½†æ˜¯å®ƒä»¬æ‰§è¡Œçš„é¡ºåºå¦‚ä½•ï¼Ÿéšæœºçš„ï¼Ÿï¼ˆåƒ`select channel`ä¸€æ ·ï¼‰ï¼Ÿå…ˆè¿›å…ˆå‡ºï¼Ÿï¼ˆè¶Šå…ˆè¢«`defer`çš„å‡½æ•°è¶Šæ—©è°ƒç”¨ï¼‰ï¼Ÿè¿˜æ˜¯å…ˆè¿›åå‡ºï¼Ÿ

æ²¡é”™ï¼Œæœ‰å¾ˆå¤šé—®é¢˜ä¼šè¦ç»•å¿ƒå¤´ã€‚æ¥å§ï¼Œè®©æˆ‘ä»¬å›ç­”ä¸Šé¢çš„é—®é¢˜ã€‚

ä¸è¿‡åœ¨æ­¤ä¹‹å‰ï¼Œå­¦ä¹ ä¸¤ä¸ªè‹±æ–‡å•è¯ã€‚

`execution`ï¼šä¸­æ–‡æ˜¯æ‰§è¡Œçš„æ„æ€ã€‚æ¯”å¦‚å‡½æ•°çš„æ‰§è¡Œï¼Œå°±æ˜¯è¿è¡Œå‡½æ•°çš„æ„æ€ã€‚

`evaluate`ï¼šä¸­æ–‡æ˜¯è¯„ä»·ã€ä¼°è®¡çš„æ„æ€ã€‚åœ¨ç¼–ç¨‹é‡Œé¢ï¼Œæ¯”å¦‚å‡½æ•°å‚æ•°ï¼Œå½“æˆ‘ä»¬è¯´`evaluate function parameters`ï¼Œå°±æ˜¯ç¡®å®šå‡½æ•°å‚æ•°å€¼çš„æ„æ€ã€‚å—¯ï¼Œ`evaluate`å¯ä»¥ç¿»è¯‘æˆã€Œæ±‚å€¼ã€ã€‚

ä¸‹é¢è¿›å…¥æ­£é¢˜ï¼š

**1ã€defered function evaluates its parameter when is occur**

è¢«`defer`çš„å‡½æ•°ä¼šç«‹é©¬æ±‚å€¼å‡½æ•°çš„å‚æ•°

```go
func print(num int) {
    fmt.Println(num)
}

func foo() {
    var i = 666
    defer print(i)
    
    i = 888
    return
}

func main() {

    foo()
}
```

ä¼šæ‰“å°`666`è€Œä¸æ˜¯`888`ã€‚

è¿™å°±å«åšå½“å‡ºç°`defer`æ—¶ï¼Œåæ¥å‡½æ•°çš„å‚æ•°ç«‹é©¬è¢«æ±‚å€¼ï¼Œç»§è€Œç¡®å®šï¼Œå³`i=666`ã€‚

è™½ç„¶`deferred function`åœ¨åé¢æ‰ä¼šæ‰§è¡Œï¼Œä½†æ˜¯å‚æ•°ä»ä¸€å¼€å§‹å°±ç¡®å®šäº†ã€‚

**2ã€defered function will execute before real return**
è¢«`defer`çš„å‡½æ•°ä¼šåœ¨è°ƒç”¨å®ƒçš„å‡½æ•°è¿”å›å‰æ‰§è¡Œ

è¿™å¥è¯ä¸å¥½ç†è§£ã€‚é‡ç‚¹åœ¨äºä»€ä¹ˆå«åš`real return`ã€‚

ä¼‘æ¯ä¸€ä¸‹ï¼Œä¸‹é¢çš„ä¾‹å­éœ€è¦ä»”ç»†çœ‹ï¼š

```go
func sara() (result int) {

    result = 1

    defer func() {
        result = 666
    }()

    return result
}

func lisa() int {

    var result = 1
    
    defer func() {
        result = 666
    }()

    return result
}

func main() {

    r := sara()
    fmt.Printf("sara finially result, %d\n", r) // 666

    r = lisa()
    fmt.Printf("lisa finially result, %d\n", r) // 1
}
```

å¯ä»¥è§‚å¯Ÿåˆ°ï¼Œ`sara`å’Œ`lisa`åŸºæœ¬é€»è¾‘æ˜¯ä¸€æ ·çš„ï¼Œå”¯ä¸€çš„ä¸åŒå°±æ˜¯`sara`æ˜¯å…·åè¿”å›å€¼å‡½æ•°ï¼Œè€Œ`lisa`æ˜¯åŒ¿åè¿”å›å€¼å‡½æ•°ã€‚è€Œè¿™ä¸€ç‚¹åŒºåˆ«å¯å¤ªé‡è¦äº†ï¼Œç›´æ¥å¯¼è‡´ä¸åŒçš„å¤„ç†é€»è¾‘ã€‚

å¥½å¥½ç†è§£ä¸€ä¸‹ä¸Šé¢çš„ä¾‹å­ï¼Œä¸‹é¢ç»™å‡º`Go`å‡½æ•°çš„è¿”å›å€¼æ¨¡å‹

å…¶å®`go`çš„`return`è¯­å¥æ˜¯åˆ†æˆä¸¤éƒ¨åˆ†çš„ã€‚æ¯”å¦‚å¯¹äºåŒ¿åè¿”å›å€¼å‡½æ•°`lisa`æ¥è¯´

```go
return result
ç›¸å½“äº

1ã€var ret = result // ret æ˜¯çœŸè¿”å›å€¼
2ã€return ret
```

å¯¹äºå…·åè¿”å›å€¼å‡½æ•°`sara`æ¥è¯´

```go
return result
ç›¸å½“äº

1ã€var result = result
2ã€return result
```

æ³¨æ„ä¸¤è€…çš„åŒºåˆ«ã€‚

é‡ç‚¹æ¥å•¦ï¼Œ`defer`çš„è¿è¡Œæ—¶æœºå°±æ˜¯æ­¥éª¤`1`å’Œæ­¥éª¤`2`ä¹‹é—´ï¼

* å¯¹äºæ™®é€šå‡½æ•°`lisa`æ¥è¯´ï¼Œæˆ‘è¦è¿”å›çš„æ˜¯`ret`ï¼Œå°±ç®—ä½ åœ¨`defer`ä¸­ä¿®æ”¹äº†`result`ï¼Œä¹Ÿä¸ä¼šå½±å“åˆ°æœ€ç»ˆè¿”å›å€¼å“¦ã€‚
* å¯¹äºå…·åè¿”å›å€¼å‡½æ•°`sara`å°±ä¸ä¸€æ ·äº†ï¼Œå¥¹è¿”å›çš„å°±æ˜¯`result`ï¼Œåœ¨`defer`ä¸­ä¿®æ”¹äº†`result`ï¼Œæœ€ç»ˆçš„ç»“æœå°±ä¸ä¸€æ ·å•¦ã€‚

å’³å’³ï¼Œå…·åè¿”å›å€¼å’Œ`defer`çš„è”åˆä½¿ç”¨ï¼Œè¦æ³¨æ„å“¦ğŸ˜‘ã€‚åˆ«å†™è¿™æ ·çš„ä»£ç ã€‚

**3ã€å¤šä¸ª`defer`çš„æ‰§è¡Œçš„é¡ºåºæ˜¯ï¼šåè¿›å…ˆå‡ºï¼Œç±»ä¼¼æ ˆ**
```golang
func print(num int) {
    fmt.Println(num)
}

func bob() {
    defer print(1)
    defer print(2)
    defer print(3)

    return
}

func main() {
    bob()
}
```

ä¼šæ‰“å°

```text
3
2
1
```

# å¦‚ä½•è®°ä½ defer çš„ç‰¹æ€§

`defer`å‡ºç°å°±æ˜¯ä¸ºäº†èµ„æºçš„ç®¡ç†ã€‚

æ¯”å¦‚æœ‰ä»¥ä¸‹è¿™ä¸ªè¿‡ç¨‹ï¼šé¦–å…ˆæ‰§è¡ŒæŸä¸ªæ“ä½œï¼Œéœ€è¦é¦–å…ˆè·å–èµ„æº`A`ï¼Œç„¶åè·å–èµ„æº`B`ï¼Œæœ€åè·å–èµ„æº`C`ã€‚é‚£ä¹ˆ`defer`çš„é¡ºåºï¼Œè‚¯å®šæ˜¯å…ˆæ”¾å›`C`èµ„æºï¼Œç„¶å`B`èµ„æºï¼Œæœ€åæ˜¯`A`èµ„æºã€‚

è¿™ä¸ªè¿‡ç¨‹è®©æˆ‘æƒ³èµ·çº¿æ€§ä»£æ•°ä¸­çŸ©é˜µçš„ä¹˜æ³•å’Œé€†è¿ç®—â€”â€”é€†çŸ©é˜µã€‚

æ¯”å¦‚`AB`ï¼Œè¡¨ç¤ºçŸ©é˜µ`A`ä¹˜ä»¥çŸ©é˜µ`B`ï¼Œé‚£ä¹ˆå®ƒä¿©çš„é€†è¿ç®—å‘¢ï¼Ÿ

$(AB)^{-1} = B^{-1}A^{-1}$

å½“æ—¶ä¸ºäº†è®°ä½è¿™ä¸ªç‰¹æ€§ï¼Œæˆ‘æ˜¯è®°ä½äº†ä¸‹é¢çš„è¿™ä¸ªç±»æ¯”ï¼š

å…ˆç©¿è¢œå­ï¼Œç„¶åç©¿é‹å­ï¼›å¦‚æœè¿™ä¸€è¿‡ç¨‹åè¿‡æ¥ï¼Œé‚£å°±æ˜¯å…ˆæ‹–é‹ï¼Œå†è„±è¢œå­ã€‚

`nice`ã€‚

ä½ ä¸èƒ½å…ˆè„±è¢œå­ï¼Œå†æ‹–é‹å•Šï¼

å¦‚ä»Šçœ‹æ¥ï¼Œä¸è®ºæ˜¯ç©¿è¡£æœã€çŸ©é˜µä¹˜æ³•ã€èµ„æºçš„ç®¡ç†ï¼Œéƒ½æ˜¯ä¸€ç§è¡Œä¸ºã€ä¸€ç§è¿åŠ¨ã€ä¸€ç§å˜åŒ–ã€‚ä»–ä»¬æ˜¯åˆ†å…ˆåçš„ï¼Œæ‰€ä»¥ä»–ä»¬çš„â€œåè¿åŠ¨â€è¦ä¸æ­£å‘è¿åŠ¨ç›¸åã€‚
